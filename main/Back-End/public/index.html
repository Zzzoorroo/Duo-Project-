<!DOCTYPE html>
<html>

<head>
    <title>Socket.IO Test</title>
</head>

<body>
    <h1>Socket.IO Test</h1>
    <h2 id="status">Connecting...</h2>
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>

    <ul id="messages"></ul>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const socket = io('http://localhost:3000');
        let username;
        let email;
        socket.on("connect", () => {
            document.getElementById("status").innerText = "Connected!";
            const username = prompt("Enter your username:");
            const email = prompt("Enter your email: ");

            socket.emit("registerUser", { username, email });
        });

        socket.on("userJoined", (data) => {
            alert(`${data.username} joined the chat!`);
        });

        socket.on("userLeft", (data) => {
            alert(`${data.username} left the chat.`)
        });

        const sendBtn = document.getElementById('sendBtn');
        const input = document.getElementById('messageInput');
        const messages = document.getElementById('messages');

        sendBtn.onclick = () => {
            const msg = input.value;
            socket.emit('message', msg);
            input.value = '';
        };


        socket.on('message', (data) => {
            const li = document.createElement('li');
            li.textContent = data;
            messages.appendChild(li);
        });

        const Message = require("../message.js");

        io.on("connection", async (socket) => {
            console.log("A user connected", socket.id);

            const lastMessage = await Message.find().sort({ timestamp: -1 }).limit(10);
            socket.emit("chatHistory", lastMessage.reverse());

            socket.om("message", async (data) => {
                const username = socket.data.username || "Anonymous";
                const msg = new Message({ username, text: data })
                await msg.save();

                io.emit("message", { username, text: data });
            });
        });
    </script>
</body>

</html>